<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="NeoYX">
<meta name="dcterms.date" content="2023-12-02">

<title>NYX Geospatial App - In-class Exercise 3: Calibrating Spatial Interaction Models with R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">NYX Geospatial App</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-hands-on-exercises" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Hands-on Exercises</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-hands-on-exercises">    
        <li>
    <a class="dropdown-item" href="../Hands-on_Ex1/Hands-on_Ex1_1.html">
 <span class="dropdown-text">Hands-on Exercise 1.1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../Hands-on_Ex1/Hands-on_Ex1_2.html">
 <span class="dropdown-text">Hands-on Exercise 1.2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../Hands-on_Ex2/Hands-on_Ex2_1.html">
 <span class="dropdown-text">Hands-on Exercise 2.1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../Hands-on_Ex2/Hands-on_Ex2_2.html">
 <span class="dropdown-text">Hands-on Exercise 2.2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../Hands-on_Ex2/Hands-on_Ex2_3.html">
 <span class="dropdown-text">Hands-on Exercise 2.3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../Hands-on_Ex3/Hands-on_Ex3_1.html">
 <span class="dropdown-text">Hands-on Exercise 3.1</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-take-home-exercises" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Take-home Exercises</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-take-home-exercises">    
        <li>
    <a class="dropdown-item" href="../Take-home_Ex1/Take-home_Ex1.html">
 <span class="dropdown-text">Take-home Exercise 1</span></a>
  </li>  
        <li class="dropdown-header">Take-home Exercise 2</li>
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-in-class-exercises" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">In-class Exercises</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-in-class-exercises">    
        <li>
    <a class="dropdown-item" href="../In-class_Ex1/In-class_Ex1.html">
 <span class="dropdown-text">In-class Exercise 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../In-class_Ex2/In-class_Ex2.html">
 <span class="dropdown-text">In-class Exercise 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../In-class_Ex3/In-class_Ex3_2.html">
 <span class="dropdown-text">In-class Exercise 3</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">In-class Exercise 3: Calibrating Spatial Interaction Models with R</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Hands-on Exercise</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Hands-on_Ex1/Hands-on_Ex1_1.html" class="sidebar-item-text sidebar-link">Hands-on Exercise 1.1: Geospatial Data Wrangling with R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Hands-on_Ex1/Hands-on_Ex1_2.html" class="sidebar-item-text sidebar-link">Hands-on Exercise 1.2: Choropleth Mapping with R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Hands-on_Ex2/Hands-on_Ex2_1.html" class="sidebar-item-text sidebar-link">Hands-on Exercise 2.1: Spatial Weights and Applications</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Hands-on_Ex2/Hands-on_Ex2_2.html" class="sidebar-item-text sidebar-link">Hands-on Exercise 2.2 and 2.3: Global and Local Measures of Spatial Autocorrelation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Hands-on_Ex2/Hands-on_Ex2_3.html" class="sidebar-item-text sidebar-link">Hands-on Exercise 2.3:Local Measures of Spatial Autocorrelation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Hands-on_Ex3/Hands-on_Ex3_1.html" class="sidebar-item-text sidebar-link">Hands-on Exercise 3.1: Processing and Visualising Flow Data</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">Take-home Exercise</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Take-home_Ex1/Take-home_Ex1.html" class="sidebar-item-text sidebar-link">Take-home_Ex1: Geospatial Analytics for Public Good</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#section" id="toc-section" class="nav-link active" data-scroll-target="#section"></a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><strong>16.1 Overview</strong></a></li>
  <li><a href="#the-case-study-and-data" id="toc-the-case-study-and-data" class="nav-link" data-scroll-target="#the-case-study-and-data"><strong>16.2 The Case Study and Data</strong></a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started"><strong>16.3 Getting Started</strong></a></li>
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data"><strong>16.4 The Data</strong></a></li>
  <li><a href="#computing-distance-matrix" id="toc-computing-distance-matrix" class="nav-link" data-scroll-target="#computing-distance-matrix"><strong>16.5 Computing Distance Matrix</strong></a>
  <ul class="collapse">
  <li><a href="#converting-from-sf-data.table-to-spatialpolygonsdataframe" id="toc-converting-from-sf-data.table-to-spatialpolygonsdataframe" class="nav-link" data-scroll-target="#converting-from-sf-data.table-to-spatialpolygonsdataframe"><strong>16.5.1 Converting from sf data.table to SpatialPolygonsDataFrame</strong></a></li>
  <li><a href="#computing-the-distance-matrix" id="toc-computing-the-distance-matrix" class="nav-link" data-scroll-target="#computing-the-distance-matrix"><strong>16.5.2 Computing the distance matrix</strong></a></li>
  <li><a href="#labelling-column-and-row-heanders-of-a-distance-matrix" id="toc-labelling-column-and-row-heanders-of-a-distance-matrix" class="nav-link" data-scroll-target="#labelling-column-and-row-heanders-of-a-distance-matrix"><strong>16.5.3 Labelling column and row heanders of a distance matrix</strong></a></li>
  <li><a href="#pivoting-distance-value-by-subzone_c" id="toc-pivoting-distance-value-by-subzone_c" class="nav-link" data-scroll-target="#pivoting-distance-value-by-subzone_c"><strong>16.5.4 Pivoting distance value by SUBZONE_C</strong></a></li>
  <li><a href="#updating-intra-zonal-distances" id="toc-updating-intra-zonal-distances" class="nav-link" data-scroll-target="#updating-intra-zonal-distances"><strong>16.5.5 Updating intra-zonal distances</strong></a></li>
  </ul></li>
  <li><a href="#preparing-flow-data" id="toc-preparing-flow-data" class="nav-link" data-scroll-target="#preparing-flow-data"><strong>16.6 Preparing flow data</strong></a>
  <ul class="collapse">
  <li><a href="#separating-intra-flow-from-passenger-volume-df" id="toc-separating-intra-flow-from-passenger-volume-df" class="nav-link" data-scroll-target="#separating-intra-flow-from-passenger-volume-df"><strong>16.6.1 Separating intra-flow from passenger volume df</strong></a></li>
  <li><a href="#combining-passenger-volume-data-with-distance-value" id="toc-combining-passenger-volume-data-with-distance-value" class="nav-link" data-scroll-target="#combining-passenger-volume-data-with-distance-value"><strong>16.6.2 Combining passenger volume data with distance value</strong></a></li>
  </ul></li>
  <li><a href="#preparing-origin-and-destination-attributes" id="toc-preparing-origin-and-destination-attributes" class="nav-link" data-scroll-target="#preparing-origin-and-destination-attributes"><strong>16.7 Preparing Origin and Destination Attributes</strong></a>
  <ul class="collapse">
  <li><a href="#importing-population-data" id="toc-importing-population-data" class="nav-link" data-scroll-target="#importing-population-data"><strong>16.7.1 Importing population data</strong></a></li>
  <li><a href="#geospatial-data-wrangling" id="toc-geospatial-data-wrangling" class="nav-link" data-scroll-target="#geospatial-data-wrangling"><strong>16.7.2 Geospatial data wrangling</strong></a></li>
  <li><a href="#preparing-origin-attribute" id="toc-preparing-origin-attribute" class="nav-link" data-scroll-target="#preparing-origin-attribute"><strong>16.7.3 Preparing origin attribute</strong></a></li>
  <li><a href="#preparing-destination-attribute" id="toc-preparing-destination-attribute" class="nav-link" data-scroll-target="#preparing-destination-attribute"><strong>16.7.4 Preparing destination attribute</strong></a></li>
  </ul></li>
  <li><a href="#calibrating-spatial-interaction-models" id="toc-calibrating-spatial-interaction-models" class="nav-link" data-scroll-target="#calibrating-spatial-interaction-models"><strong>16.8 Calibrating Spatial Interaction Models</strong></a>
  <ul class="collapse">
  <li><a href="#importing-the-modelling-data" id="toc-importing-the-modelling-data" class="nav-link" data-scroll-target="#importing-the-modelling-data"><strong>16.8.1 Importing the modelling data</strong></a></li>
  <li><a href="#visualising-the-dependent-variable" id="toc-visualising-the-dependent-variable" class="nav-link" data-scroll-target="#visualising-the-dependent-variable"><strong>16.8.2 Visualising the dependent variable</strong></a></li>
  <li><a href="#checking-for-variables-with-zero-values" id="toc-checking-for-variables-with-zero-values" class="nav-link" data-scroll-target="#checking-for-variables-with-zero-values"><strong>16.8.3 Checking for variables with zero values</strong></a></li>
  <li><a href="#unconstrained-spatial-interaction-model" id="toc-unconstrained-spatial-interaction-model" class="nav-link" data-scroll-target="#unconstrained-spatial-interaction-model"><strong>16.8.4 Unconstrained Spatial Interaction Model</strong></a></li>
  </ul></li>
  <li><a href="#summaries" id="toc-summaries" class="nav-link" data-scroll-target="#summaries">Summaries</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">In-class Exercise 3: Calibrating Spatial Interaction Models with R</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>NeoYX </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 2, 2023</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">December 2, 2023</p>
    </div>
  </div>
    
  </div>
  

</header>

<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>
</section>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview"><strong>16.1 Overview</strong></h2>
<p>Spatial Interaction Models (SIMs) are mathematical models for estimating flows between spatial entities developed by Alan Wilson in the late 1960s and early 1970, with considerable uptake and refinement for transport modelling since then Boyce and Williams (2015).</p>
<p>There are four main types of traditional SIMs (Wilson 1971):</p>
<ul>
<li><p>Unconstrained</p></li>
<li><p>Production-constrained</p></li>
<li><p>Attraction-constrained</p></li>
<li><p>Doubly-constrained</p></li>
</ul>
<p>Ordinary least square (OLS), log-normal, Poisson and negative binomial (NB) regression methods have been used extensively to calibrate OD flow models by processing flow data as different types of dependent variables. In this chapter, you will gain hands-on experiences on using appropriate R packages to calibrate SIM by using there four regression methods.</p>
</section>
<section id="the-case-study-and-data" class="level2">
<h2 class="anchored" data-anchor-id="the-case-study-and-data"><strong>16.2 The Case Study and Data</strong></h2>
<p>In this exercise, we are going to calibrate SIM to determine factors affecting the public bus passenger flows during the morning peak in Singapore.</p>
</section>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started"><strong>16.3 Getting Started</strong></h2>
<p>For the purpose of this exercise, four R packages will be used. They are:</p>
<ul>
<li><p>sf for importing, integrating, processing and transforming geospatial data.</p></li>
<li><p>sp package , although an older package, is more efficient for computation of large data.</p></li>
<li><p>tidyverse for importing, integrating, wrangling and visualising data.</p></li>
<li><p>tmap for creating thematic maps</p></li>
<li><p><a href="https://rpkgs.datanovia.com/ggpubr/">ggpubr</a> for some easy-to-use functions (like <code>ggarrange()</code>)for creating and customizing ‘ggplot2’- based publication ready plots.</p></li>
<li><p><a href="https://easystats.github.io/performance/">performance</a> is part of the <a href="https://easystats.github.io/easystats/"><code>easystats</code></a> package for computing measures to assess model quality, which are not directly provided by R’s ‘base’ or ‘stats’ packages. The primary goal of the <strong>performance</strong> package is to provide utilities for computing indices of model quality and goodness of fit. These include measures like r-squared (R2), root mean squared error (RMSE)</p></li>
<li><p><code>reshape2</code> is an old tool from base R. It handles matrix well for our distance matrix, like pivoting function like <code>melt()</code>. Tidyverse does not handle matrix very well.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tmap, sf, sp, DT,</span>
<span id="cb1-2"><a href="#cb1-2"></a>               performance, reshape2,</span>
<span id="cb1-3"><a href="#cb1-3"></a>               ggpubr, tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-data" class="level2">
<h2 class="anchored" data-anchor-id="the-data"><strong>16.4 The Data</strong></h2>
<p>This exercise is a continuation of <strong>Chapter 15: Processing and Visualising Flow Data</strong> and the following data will be used:</p>
<ul>
<li><p><em>od_data.rds</em>, weekday morning peak passenger flows at planning subzone level.</p></li>
<li><p><em>mpsz.rds</em>, URA Master Plan 2019 Planning Subzone boundary in simple feature tibble data frame format.</p></li>
</ul>
<p>Beside these two data sets, an additional attribute data file called pop.csv will be provided. It</p>
</section>
<section id="computing-distance-matrix" class="level2">
<h2 class="anchored" data-anchor-id="computing-distance-matrix"><strong>16.5 Computing Distance Matrix</strong></h2>
<p>In spatial interaction, a distance matrix is a table that shows the distance between pairs of locations. For example, in the table below we can see an Euclidean distance of 3926.0025 between MESZ01 and RVSZ05, of 3939.1079 between MESZ01 and SRSZ01, and so on. By definition, an location’s distance from itself, which is shown in the main diagonal of the table, is 0.</p>
<p><img src="https://r4gdsa.netlify.app/chap16/img/image16-1.jpg" class="img-fluid"></p>
<p>In this section, you will learn how to compute a distance matrix by using URA Master Plan 2019 Planning Subzone boundary in which you saved as an rds file called <em>mpsz</em>.</p>
<p>First, let us import <em>mpsz.rds</em> into R environemnt by using the code chunk below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>mpsz <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"data/geospatial"</span>,</span>
<span id="cb2-2"><a href="#cb2-2"></a>                   <span class="at">layer =</span> <span class="st">"MPSZ-2019"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">3414</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `MPSZ-2019' from data source 
  `C:\yixin-neo\ISSS624_AGA\In-class_Ex3\data\geospatial' using driver `ESRI Shapefile'
Simple feature collection with 332 features and 6 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 103.6057 ymin: 1.158699 xmax: 104.0885 ymax: 1.470775
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>mpsz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 332 features and 6 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 2667.538 ymin: 15748.72 xmax: 56396.44 ymax: 50256.33
Projected CRS: SVY21 / Singapore TM
First 10 features:
                 SUBZONE_N SUBZONE_C       PLN_AREA_N PLN_AREA_C       REGION_N
1              MARINA EAST    MESZ01      MARINA EAST         ME CENTRAL REGION
2         INSTITUTION HILL    RVSZ05     RIVER VALLEY         RV CENTRAL REGION
3           ROBERTSON QUAY    SRSZ01  SINGAPORE RIVER         SR CENTRAL REGION
4  JURONG ISLAND AND BUKOM    WISZ01  WESTERN ISLANDS         WI    WEST REGION
5             FORT CANNING    MUSZ02           MUSEUM         MU CENTRAL REGION
6         MARINA EAST (MP)    MPSZ05    MARINE PARADE         MP CENTRAL REGION
7                   SUDONG    WISZ03  WESTERN ISLANDS         WI    WEST REGION
8                  SEMAKAU    WISZ02  WESTERN ISLANDS         WI    WEST REGION
9           SOUTHERN GROUP    SISZ02 SOUTHERN ISLANDS         SI CENTRAL REGION
10                 SENTOSA    SISZ01 SOUTHERN ISLANDS         SI CENTRAL REGION
   REGION_C                       geometry
1        CR MULTIPOLYGON (((33222.98 29...
2        CR MULTIPOLYGON (((28481.45 30...
3        CR MULTIPOLYGON (((28087.34 30...
4        WR MULTIPOLYGON (((14557.7 304...
5        CR MULTIPOLYGON (((29542.53 31...
6        CR MULTIPOLYGON (((35279.55 30...
7        WR MULTIPOLYGON (((15772.59 21...
8        WR MULTIPOLYGON (((19843.41 21...
9        CR MULTIPOLYGON (((30870.53 22...
10       CR MULTIPOLYGON (((26879.04 26...</code></pre>
</div>
</div>
<p>Notice that it is a sf tibble dataframe object class.</p>
<section id="converting-from-sf-data.table-to-spatialpolygonsdataframe" class="level3">
<h3 class="anchored" data-anchor-id="converting-from-sf-data.table-to-spatialpolygonsdataframe"><strong>16.5.1 Converting from sf data.table to SpatialPolygonsDataFrame</strong></h3>
<p>There are at least two ways to compute the required distance matrix. One is based on sf and the other is based on sp. Past experience shown that computing distance matrix by using sf function took relatively longer time that sp method especially the data set is large. In view of this, sp method is used in the code chunks below.</p>
<p>First <a href="https://r-spatial.github.io/sf/reference/coerce-methods.html"><code>as.Spatial()</code></a> will be used to convert <em>mpsz</em> from sf tibble data frame to SpatialPolygonsDataFrame of sp object as shown in the code chunk below.</p>
<p>It has become a large spatialpolygendataframe (older). It contains a data table inside, but no geometry column (contain in another table). Wheras in new sf, everything is in a single table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>mpsz_sp <span class="ot">&lt;-</span> <span class="fu">as</span>(mpsz, <span class="st">"Spatial"</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">#mpsz_sp &lt;- mpsz %&gt;% </span></span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="co">#as.Spatial()</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>mpsz_sp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>class       : SpatialPolygonsDataFrame 
features    : 332 
extent      : 2667.538, 56396.44, 15748.72, 50256.33  (xmin, xmax, ymin, ymax)
crs         : +proj=tmerc +lat_0=1.36666666666667 +lon_0=103.833333333333 +k=1 +x_0=28001.642 +y_0=38744.572 +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs 
variables   : 6
names       : SUBZONE_N, SUBZONE_C, PLN_AREA_N, PLN_AREA_C,       REGION_N, REGION_C 
min values  : ADMIRALTY,    AMSZ01, ANG MO KIO,         AM, CENTRAL REGION,       CR 
max values  :    YUNNAN,    YSSZ09,     YISHUN,         YS,    WEST REGION,       WR </code></pre>
</div>
</div>
<p>Exploration: How to access a SpatialPolygonDataFrame object of the older sp package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>mpsz_sp[<span class="st">'SUBZONE_N'</span>][[<span class="dv">1</span>]]</span>
<span id="cb8-2"><a href="#cb8-2"></a>mpsz_sp<span class="sc">@</span>data  <span class="co"># class dataframe</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>mpsz_sp<span class="sc">@</span>polygons <span class="co"># class: list</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>mpsz_sp<span class="sc">@</span>polygons[[<span class="dv">1</span>]]  <span class="co"># access the first polygon / subzone</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>mpsz_sp<span class="sc">@</span>polygons[[<span class="dv">1</span>]]<span class="sc">@</span>Polygons <span class="co"># access the slot in the polygon object that contains information about individual Polygons within the overall geometry</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>mpsz_sp<span class="sc">@</span>polygons[[<span class="dv">1</span>]]<span class="sc">@</span>Polygons[[<span class="dv">1</span>]] <span class="co"># same as above, enter another layer</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>mpsz_sp<span class="sc">@</span>polygons[[<span class="dv">1</span>]]<span class="sc">@</span>Polygons[[<span class="dv">1</span>]]<span class="sc">@</span>coords <span class="co">#get the coordinates of the first polygon / subzone</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>mpsz_sp<span class="sc">@</span>polygons[[<span class="dv">332</span>]]<span class="sc">@</span>Polygons[[<span class="dv">1</span>]]<span class="sc">@</span>coords <span class="co">#total of 333 subzones</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="computing-the-distance-matrix" class="level3">
<h3 class="anchored" data-anchor-id="computing-the-distance-matrix"><strong>16.5.2 Computing the distance matrix</strong></h3>
<p>Next, <a href="https://www.rdocumentation.org/packages/sp/versions/2.1-1/topics/spDistsN1"><code>spDists()</code></a> of sp package will be used to compute the Euclidean distance between the centroids of the planning subzones.</p>
<p><code>spDists(x, y = x, longlat = FALSE, segments = FALSE, diagonal = FALSE)</code></p>
<p>spDists returns a full matrix of distances in the metric of the points if longlat=FALSE, or in kilometers if longlat=TRUE; it uses spDistsN1 in case points are two-dimensional. In case of spDists(x,x), it will compute all n x n distances, not the sufficient n x (n-1).</p>
<p><strong>Arguments</strong></p>
<p>x: A matrix of n-D points with row denoting points, first column x/longitude, second column y/latitude, or a Spatial object that has a coordinates method</p>
<p>y: A matrix of n-D points with row denoting points, first column x/longitude, second column y/latitude, or a Spatial object that has a coordinates method</p>
<p>longlat: logical; if FALSE (default), Euclidean distance, if TRUE Great Circle (WGS84 ellipsoid) distance; if x is a Spatial object, longlat should not be specified but will be derived from is.projected(x)</p>
<p>segments: logical; if TRUE, y must be missing; the vector of distances between consecutive points in x is returned.</p>
<p>diagonal: logical; if TRUE, y must be given and have the same number of points as x; the vector with distances between points with identical index is returned.</p>
<p>The diagonals of the ouput (332 by 332) are all 0. Distance with itself. The unit of distance is if ‘m’ (euclidean?) and km if WSG84?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>dist <span class="ot">&lt;-</span> <span class="fu">spDists</span>(mpsz_sp, </span>
<span id="cb9-2"><a href="#cb9-2"></a>                <span class="at">longlat =</span> <span class="cn">FALSE</span>) <span class="co"># already projected in EPSG:3414</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="fu">head</span>(dist, <span class="at">n=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]       [,2]      [,3]      [,4]       [,5]      [,6]      [,7]
 [1,]     0.000  3926.0025  3939.108 20252.964  2989.9839  1431.330 19211.836
 [2,]  3926.003     0.0000   305.737 16513.865   951.8314  5254.066 16242.523
 [3,]  3939.108   305.7370     0.000 16412.062  1045.9088  5299.849 16026.146
 [4,] 20252.964 16513.8648 16412.062     0.000 17450.3044 21665.795  7229.017
 [5,]  2989.984   951.8314  1045.909 17450.304     0.0000  4303.232 17020.916
 [6,]  1431.330  5254.0664  5299.849 21665.795  4303.2323     0.000 20617.082
 [7,] 19211.836 16242.5230 16026.146  7229.017 17020.9161 20617.082     0.000
 [8,] 14960.942 12749.4101 12477.871 11284.279 13336.0421 16281.453  5606.082
 [9,]  7515.256  7934.8082  7649.776 18427.503  7801.6163  8403.896 14810.930
[10,]  6391.342  4975.0021  4669.295 15469.566  5226.8731  7707.091 13111.391
           [,8]      [,9]     [,10]
 [1,] 14960.942  7515.256  6391.342
 [2,] 12749.410  7934.808  4975.002
 [3,] 12477.871  7649.776  4669.295
 [4,] 11284.279 18427.503 15469.566
 [5,] 13336.042  7801.616  5226.873
 [6,] 16281.453  8403.896  7707.091
 [7,]  5606.082 14810.930 13111.391
 [8,]     0.000  9472.024  8575.490
 [9,]  9472.024     0.000  3780.800
[10,]  8575.490  3780.800     0.000</code></pre>
</div>
</div>
<p>Notice that the output <em>dist</em> is a matrix object class of R. Also notice that the column heanders and row headers are not labeled with the planning subzone codes.</p>
</section>
<section id="labelling-column-and-row-heanders-of-a-distance-matrix" class="level3">
<h3 class="anchored" data-anchor-id="labelling-column-and-row-heanders-of-a-distance-matrix"><strong>16.5.3 Labelling column and row heanders of a distance matrix</strong></h3>
<p>First, we will create a list sorted according to the the distance matrix by planning sub-zone code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>sz_names <span class="ot">&lt;-</span> mpsz<span class="sc">$</span>SUBZONE_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we will attach <code>SUBZONE_C</code> to row and column for distance matrix matching ahead</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">colnames</span>(dist) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(sz_names)</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="fu">rownames</span>(dist) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(sz_names)</span>
<span id="cb12-3"><a href="#cb12-3"></a>dist[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          MESZ01     RVSZ05    SRSZ01   WISZ01     MUSZ02
MESZ01     0.000  3926.0025  3939.108 20252.96  2989.9839
RVSZ05  3926.003     0.0000   305.737 16513.86   951.8314
SRSZ01  3939.108   305.7370     0.000 16412.06  1045.9088
WISZ01 20252.964 16513.8648 16412.062     0.00 17450.3044
MUSZ02  2989.984   951.8314  1045.909 17450.30     0.0000</code></pre>
</div>
</div>
</section>
<section id="pivoting-distance-value-by-subzone_c" class="level3">
<h3 class="anchored" data-anchor-id="pivoting-distance-value-by-subzone_c"><strong>16.5.4 Pivoting distance value by SUBZONE_C</strong></h3>
<p>Next, we will pivot the distance matrix into a long table by using the row and column subzone codes as show in the code chunk below.</p>
<p>We will use the <a href="https://seananderson.ca/2013/10/19/reshape/">melt()</a> function of the reshape2 package to convert wide-format data to long-format data. This function will convert wide-format data to a data frame with columns for each combination of row and column indices and their corresponding values.</p>
<p>To do the opposite, used cast().</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">wide</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">long</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3]
[1,]    1    3    5
[2,]    2    4    6</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>reshape2<span class="sc">::</span><span class="fu">melt</span>(<span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>, <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">3</span>)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">Var1</th>
<th style="text-align: right;">Var2</th>
<th style="text-align: right;">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">6</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<p>Three new columns generated, (1) ‘var1’, (2) ‘var2’ and (3) ‘value’ containing the distance for the corresponding var1-var2 pair; thus rename to ‘dist’.</p>
<p>There are 110,224 rows in distPair due to 332P2 + 332 = 332*331 + 332. Number of possible permutations with replacement.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>distPair <span class="ot">&lt;-</span> <span class="fu">melt</span>(dist) <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">rename</span>(<span class="at">dist =</span> value)</span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="fu">head</span>(distPair, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     Var1   Var2      dist
1  MESZ01 MESZ01     0.000
2  RVSZ05 MESZ01  3926.003
3  SRSZ01 MESZ01  3939.108
4  WISZ01 MESZ01 20252.964
5  MUSZ02 MESZ01  2989.984
6  MPSZ05 MESZ01  1431.330
7  WISZ03 MESZ01 19211.836
8  WISZ02 MESZ01 14960.942
9  SISZ02 MESZ01  7515.256
10 SISZ01 MESZ01  6391.342</code></pre>
</div>
</div>
<p>Notice that the within zone distance is 0.</p>
</section>
<section id="updating-intra-zonal-distances" class="level3">
<h3 class="anchored" data-anchor-id="updating-intra-zonal-distances"><strong>16.5.5 Updating intra-zonal distances</strong></h3>
<p>In this section, we are going to append a constant value to replace the intra-zonal distance of 0.</p>
<p>First, we will select and find out the <strong>minimum value</strong> of the distance by using <code>summary()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>distPair <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="fu">filter</span>(dist <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Var1             Var2             dist        
 MESZ01 :   331   MESZ01 :   331   Min.   :  173.8  
 RVSZ05 :   331   RVSZ05 :   331   1st Qu.: 7149.5  
 SRSZ01 :   331   SRSZ01 :   331   Median :11890.0  
 WISZ01 :   331   WISZ01 :   331   Mean   :12229.4  
 MUSZ02 :   331   MUSZ02 :   331   3rd Qu.:16401.7  
 MPSZ05 :   331   MPSZ05 :   331   Max.   :49894.4  
 (Other):107906   (Other):107906                    </code></pre>
</div>
</div>
<p>After removing distance = 0 (intra), the minimum inter-zonal distance is 173.8m.</p>
<p>Next, a constant distance value of 50m (<strong>estimate based on 173.8m</strong>) is added into intra-zones distance. The diagonals of dist matrix (if still a matrix) would have been 50m.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>distPair<span class="sc">$</span>dist <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(distPair<span class="sc">$</span>dist <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb21-2"><a href="#cb21-2"></a>                        <span class="dv">50</span>, distPair<span class="sc">$</span>dist)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code chunk below will be used to check the result data.frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>distPair <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Var1             Var2             dist      
 MESZ01 :   332   MESZ01 :   332   Min.   :   50  
 RVSZ05 :   332   RVSZ05 :   332   1st Qu.: 7097  
 SRSZ01 :   332   SRSZ01 :   332   Median :11864  
 WISZ01 :   332   WISZ01 :   332   Mean   :12193  
 MUSZ02 :   332   MUSZ02 :   332   3rd Qu.:16388  
 MPSZ05 :   332   MPSZ05 :   332   Max.   :49894  
 (Other):108232   (Other):108232                  </code></pre>
</div>
</div>
<p>The code chunk below is used to rename the origin and destination fields.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>distPair <span class="ot">&lt;-</span> distPair <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="fu">rename</span>(<span class="at">orig =</span> Var1,</span>
<span id="cb24-3"><a href="#cb24-3"></a>         <span class="at">dest =</span> Var2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, the code chunk below is used to save the dataframe for future use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">write_rds</span>(distPair, <span class="st">"data/rds/distPair.rds"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="preparing-flow-data" class="level2">
<h2 class="anchored" data-anchor-id="preparing-flow-data"><strong>16.6 Preparing flow data</strong></h2>
<p>The code chunk below is used import <em>od_data</em> save in Chapter 15 into R environment.</p>
<p>There are 310 unique origin subzone values and 311 unique destin subzone values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>od_data <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/od_data.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we will compute the total passenger trip between and within planning subzones by using the code chunk below. The output is all <em>flow_data</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>flow_data <span class="ot">&lt;-</span> od_data <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">group_by</span>(ORIGIN_SZ, DESTIN_SZ) <span class="sc">%&gt;%</span> </span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">summarize</span>(<span class="at">TRIPS =</span> <span class="fu">sum</span>(MORNING_PEAK)) </span>
<span id="cb27-4"><a href="#cb27-4"></a></span>
<span id="cb27-5"><a href="#cb27-5"></a><span class="fu">head</span>(flow_data, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
# Groups:   ORIGIN_SZ [1]
   ORIGIN_SZ DESTIN_SZ TRIPS
   &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;
 1 AMSZ01    AMSZ01     2575
 2 AMSZ01    AMSZ02    11742
 3 AMSZ01    AMSZ03    14886
 4 AMSZ01    AMSZ04     3237
 5 AMSZ01    AMSZ05     9349
 6 AMSZ01    AMSZ06     2231
 7 AMSZ01    AMSZ07     1714
 8 AMSZ01    AMSZ08     2624
 9 AMSZ01    AMSZ09     2371
10 AMSZ01    AMSZ10      183</code></pre>
</div>
</div>
<section id="separating-intra-flow-from-passenger-volume-df" class="level3">
<h3 class="anchored" data-anchor-id="separating-intra-flow-from-passenger-volume-df"><strong>16.6.1 Separating intra-flow from passenger volume df</strong></h3>
<p>Code chunk below is used to add three new fields in <code>flow_data</code> dataframe.</p>
<p>Two new fields called ‘FlowNoIntra’ and ‘offset’ are created.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>flow_data<span class="sc">$</span>FlowNoIntra <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb29-2"><a href="#cb29-2"></a>  flow_data<span class="sc">$</span>ORIGIN_SZ <span class="sc">==</span> flow_data<span class="sc">$</span>DESTIN_SZ, </span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="dv">0</span>, flow_data<span class="sc">$</span>TRIPS)</span>
<span id="cb29-4"><a href="#cb29-4"></a>flow_data<span class="sc">$</span>offset <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb29-5"><a href="#cb29-5"></a>  flow_data<span class="sc">$</span>ORIGIN_SZ <span class="sc">==</span> flow_data<span class="sc">$</span>DESTIN_SZ, </span>
<span id="cb29-6"><a href="#cb29-6"></a>  <span class="fl">0.000001</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Print</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="fu">head</span>(flow_data,<span class="dv">3</span>) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">ORIGIN_SZ</th>
<th style="text-align: left;">DESTIN_SZ</th>
<th style="text-align: right;">TRIPS</th>
<th style="text-align: right;">FlowNoIntra</th>
<th style="text-align: right;">offset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: right;">2575</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1e-06</td>
</tr>
<tr class="even">
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: left;">AMSZ02</td>
<td style="text-align: right;">11742</td>
<td style="text-align: right;">11742</td>
<td style="text-align: right;">1e+00</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: left;">AMSZ03</td>
<td style="text-align: right;">14886</td>
<td style="text-align: right;">14886</td>
<td style="text-align: right;">1e+00</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">glimpse</span>(flow_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 20,987
Columns: 5
Groups: ORIGIN_SZ [310]
$ ORIGIN_SZ   &lt;chr&gt; "AMSZ01", "AMSZ01", "AMSZ01", "AMSZ01", "AMSZ01", "AMSZ01"…
$ DESTIN_SZ   &lt;chr&gt; "AMSZ01", "AMSZ02", "AMSZ03", "AMSZ04", "AMSZ05", "AMSZ06"…
$ TRIPS       &lt;dbl&gt; 2575, 11742, 14886, 3237, 9349, 2231, 1714, 2624, 2371, 18…
$ FlowNoIntra &lt;dbl&gt; 0, 11742, 14886, 3237, 9349, 2231, 1714, 2624, 2371, 183, …
$ offset      &lt;dbl&gt; 1e-06, 1e+00, 1e+00, 1e+00, 1e+00, 1e+00, 1e+00, 1e+00, 1e…</code></pre>
</div>
</div>
</section>
<section id="combining-passenger-volume-data-with-distance-value" class="level3">
<h3 class="anchored" data-anchor-id="combining-passenger-volume-data-with-distance-value"><strong>16.6.2 Combining passenger volume data with distance value</strong></h3>
<p>Before we can join <em>flow_data</em> and <em>distPair</em>, we need to convert data value type of <em>ORIGIN_SZ</em> and <em>DESTIN_SZ</em> fields of flow_data dataframe into factor data type.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>flow_data<span class="sc">$</span>ORIGIN_SZ <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(flow_data<span class="sc">$</span>ORIGIN_SZ)</span>
<span id="cb33-2"><a href="#cb33-2"></a>flow_data<span class="sc">$</span>DESTIN_SZ <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(flow_data<span class="sc">$</span>DESTIN_SZ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, <code>left_join()</code> of <strong>dplyr</strong> will be used to <em>flow_data</em> dataframe and <em>distPair</em> dataframe. The output is called <em>flow_data1</em>.</p>
<p>Notes:</p>
<p><code>distPair</code> is a df containing distances for all corresponding subzone pairs (including self, default to 50m). ‘var1’, ‘var2’, ‘dist’</p>
<p><code>flow_data</code> is a df containing ‘origin_sz’, ‘destin_sb’ and ‘morning_peak’</p>
<p>We will now perform a left join with two sets join keys.</p>
<p>The output contains <strong>distance</strong> and total morning peak trips for each possible pairs of subzones (self included).</p>
<p>Before left join:</p>
<p><code>flow_data</code> has 20,987 rows.</p>
<p><code>distPair</code> has 110,224 rows (is the all possible pairs out of 332 subzones, order matters and with replacement.)</p>
<p>After join:</p>
<p><code>flow_data1</code> has 20,987 rows.</p>
<p><code>flow_data</code> has no distance. <code>flow_data1</code> has distance data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>flow_data1 <span class="ot">&lt;-</span> flow_data <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>  <span class="fu">left_join</span> (distPair,</span>
<span id="cb34-3"><a href="#cb34-3"></a>             <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ORIGIN_SZ"</span> <span class="ot">=</span> <span class="st">"orig"</span>,</span>
<span id="cb34-4"><a href="#cb34-4"></a>                    <span class="st">"DESTIN_SZ"</span> <span class="ot">=</span> <span class="st">"dest"</span>))</span>
<span id="cb34-5"><a href="#cb34-5"></a></span>
<span id="cb34-6"><a href="#cb34-6"></a><span class="fu">glimpse</span>(flow_data1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 20,987
Columns: 6
Groups: ORIGIN_SZ [310]
$ ORIGIN_SZ   &lt;fct&gt; AMSZ01, AMSZ01, AMSZ01, AMSZ01, AMSZ01, AMSZ01, AMSZ01, AM…
$ DESTIN_SZ   &lt;fct&gt; AMSZ01, AMSZ02, AMSZ03, AMSZ04, AMSZ05, AMSZ06, AMSZ07, AM…
$ TRIPS       &lt;dbl&gt; 2575, 11742, 14886, 3237, 9349, 2231, 1714, 2624, 2371, 18…
$ FlowNoIntra &lt;dbl&gt; 0, 11742, 14886, 3237, 9349, 2231, 1714, 2624, 2371, 183, …
$ offset      &lt;dbl&gt; 1e-06, 1e+00, 1e+00, 1e+00, 1e+00, 1e+00, 1e+00, 1e+00, 1e…
$ dist        &lt;dbl&gt; 50.0000, 810.4491, 1360.9294, 840.4432, 1076.7916, 805.297…</code></pre>
</div>
</div>
<p>Print out</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="fu">head</span>(flow_data1) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">ORIGIN_SZ</th>
<th style="text-align: left;">DESTIN_SZ</th>
<th style="text-align: right;">TRIPS</th>
<th style="text-align: right;">FlowNoIntra</th>
<th style="text-align: right;">offset</th>
<th style="text-align: right;">dist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: right;">2575</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1e-06</td>
<td style="text-align: right;">50.0000</td>
</tr>
<tr class="even">
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: left;">AMSZ02</td>
<td style="text-align: right;">11742</td>
<td style="text-align: right;">11742</td>
<td style="text-align: right;">1e+00</td>
<td style="text-align: right;">810.4491</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: left;">AMSZ03</td>
<td style="text-align: right;">14886</td>
<td style="text-align: right;">14886</td>
<td style="text-align: right;">1e+00</td>
<td style="text-align: right;">1360.9294</td>
</tr>
<tr class="even">
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: left;">AMSZ04</td>
<td style="text-align: right;">3237</td>
<td style="text-align: right;">3237</td>
<td style="text-align: right;">1e+00</td>
<td style="text-align: right;">840.4432</td>
</tr>
<tr class="odd">
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: left;">AMSZ05</td>
<td style="text-align: right;">9349</td>
<td style="text-align: right;">9349</td>
<td style="text-align: right;">1e+00</td>
<td style="text-align: right;">1076.7916</td>
</tr>
<tr class="even">
<td style="text-align: left;">AMSZ01</td>
<td style="text-align: left;">AMSZ06</td>
<td style="text-align: right;">2231</td>
<td style="text-align: right;">2231</td>
<td style="text-align: right;">1e+00</td>
<td style="text-align: right;">805.2979</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="preparing-origin-and-destination-attributes" class="level2">
<h2 class="anchored" data-anchor-id="preparing-origin-and-destination-attributes"><strong>16.7 Preparing Origin and Destination Attributes</strong></h2>
<section id="importing-population-data" class="level3">
<h3 class="anchored" data-anchor-id="importing-population-data"><strong>16.7.1 Importing population data</strong></h3>
<p>‘pop.csv’ is a processed version of ‘respopagesextod2011to2020.csv’ .</p>
<p>The original dataset used here is the <em>Singapore Residents by Planning Area / Subzone, Single Year of Age and Sex, June 2022</em> in csv format . This is an aspatial data file. It can be downloaded at <a href="https://www.singstat.gov.sg/">Department of Statistics</a>, Singapore, the specific link can be found <a href="https://www.singstat.gov.sg/find-data/search-by-theme/population/geographic-distribution/latest-data">here</a>. Although it does not contain any coordinates values, but it’s ‘PA’ and ‘SZ’ fields can be used as unique identifiers to geocode to ‘PLAN_AREA_N’ and ‘SUBZONE_N’ of the MP14_SUBZONE_WEB_PL shapefile respectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>pop <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/aspatial/pop.csv"</span>)</span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="fu">head</span>(pop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  PA         SZ                     AGE7_12 AGE13_24 AGE25_64
  &lt;chr&gt;      &lt;chr&gt;                    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 ANG MO KIO ANG MO KIO TOWN CENTRE     310      710     2780
2 ANG MO KIO CHENG SAN                 1140     2770    15700
3 ANG MO KIO CHONG BOON                1010     2650    14240
4 ANG MO KIO KEBUN BAHRU               1050     2390    12460
5 ANG MO KIO SEMBAWANG HILLS            420     1120     3620
6 ANG MO KIO SHANGRI-LA                 810     1920     9650</code></pre>
</div>
</div>
<p><strong>Why is the data prepared in this way?</strong></p>
<p>Age group 7-12: Feeder bus to send kids to school</p>
<p>Age group 13-24: Feeder bus for secondary / JC / ITE/ poly students to school.</p>
<p><strong>Interesting observation</strong>: When we examine the flow map in Hands-on_Ex3, the top few flow movement by bus have their destinations at Republic Poly in woodlands, AMK central ITE along AMK ave 5 for instance.</p>
</section>
<section id="geospatial-data-wrangling" class="level3">
<h3 class="anchored" data-anchor-id="geospatial-data-wrangling"><strong>16.7.2 Geospatial data wrangling</strong></h3>
<p><strong>POP + MPSZ</strong></p>
<p>Let us append the zone codes in <code>mpsz</code> df to the <code>pop</code>’s population data by age groups. We do not really need to geometry data.</p>
<p><code>pop</code> has 332 rows</p>
<p>mpsz has 332 rows</p>
<p>After join: 984,656 rows</p>
<p>Column selected are ‘PA’, ‘SZ’, ‘AGE7-12’, ‘AGE13-24’, ‘AGE25_64’ from pop df and ‘SUBZONE_C’ from mpsz df.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>pop <span class="ot">&lt;-</span> pop <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="fu">left_join</span>(mpsz,</span>
<span id="cb39-3"><a href="#cb39-3"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"PA"</span> <span class="ot">=</span> <span class="st">"PLN_AREA_N"</span>,</span>
<span id="cb39-4"><a href="#cb39-4"></a>                   <span class="st">"SZ"</span> <span class="ot">=</span> <span class="st">"SUBZONE_N"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>  <span class="fu">select</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-6"><a href="#cb39-6"></a>  <span class="fu">rename</span>(<span class="at">SZ_NAME =</span> SZ,</span>
<span id="cb39-7"><a href="#cb39-7"></a>         <span class="at">SZ =</span> SUBZONE_C)</span>
<span id="cb39-8"><a href="#cb39-8"></a></span>
<span id="cb39-9"><a href="#cb39-9"></a><span class="fu">head</span>(pop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 6
  PA         SZ_NAME                AGE7_12 AGE13_24 AGE25_64 SZ    
  &lt;chr&gt;      &lt;chr&gt;                    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt; 
1 ANG MO KIO ANG MO KIO TOWN CENTRE     310      710     2780 AMSZ01
2 ANG MO KIO CHENG SAN                 1140     2770    15700 AMSZ02
3 ANG MO KIO CHONG BOON                1010     2650    14240 AMSZ03
4 ANG MO KIO KEBUN BAHRU               1050     2390    12460 AMSZ06
5 ANG MO KIO SEMBAWANG HILLS            420     1120     3620 AMSZ07
6 ANG MO KIO SHANGRI-LA                 810     1920     9650 AMSZ05</code></pre>
</div>
</div>
</section>
<section id="preparing-origin-attribute" class="level3">
<h3 class="anchored" data-anchor-id="preparing-origin-attribute"><strong>16.7.3 Preparing origin attribute</strong></h3>
<p><strong>FLOW_DATA1 + POP</strong></p>
<p>We would like to append the <strong>origin’s population data</strong> from <code>pop</code> to <code>flow_data1</code> that <strong>contains(1) origin -destination pair, (2) actual flows and (3) distance information.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>flow_data1 <span class="ot">&lt;-</span> flow_data1 <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>  <span class="fu">left_join</span>(pop,</span>
<span id="cb41-3"><a href="#cb41-3"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="at">ORIGIN_SZ =</span> <span class="st">"SZ"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb41-4"><a href="#cb41-4"></a>  <span class="fu">rename</span>(<span class="at">ORIGIN_AGE7_12 =</span> AGE7_12,</span>
<span id="cb41-5"><a href="#cb41-5"></a>         <span class="at">ORIGIN_AGE13_24 =</span> AGE13_24,</span>
<span id="cb41-6"><a href="#cb41-6"></a>         <span class="at">ORIGIN_AGE25_64 =</span> AGE25_64) <span class="sc">%&gt;%</span></span>
<span id="cb41-7"><a href="#cb41-7"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(PA, SZ_NAME))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Morning pea</em>k: the <strong>push</strong> factor should be the population from origin population distribution.</p>
<p><em>Evening peak</em> : the <strong>pull</strong> factor would be the population too.</p>
<p>Limits of our model: transfer trips not accounted for.</p>
</section>
<section id="preparing-destination-attribute" class="level3">
<h3 class="anchored" data-anchor-id="preparing-destination-attribute"><strong>16.7.4 Preparing destination attribute</strong></h3>
<p>Similarly, we want to get the destination’s population data by destination from <code>pop</code>. Once again, perform a left join.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>flow_data1 <span class="ot">&lt;-</span> flow_data1 <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>  <span class="fu">left_join</span>(pop,</span>
<span id="cb42-3"><a href="#cb42-3"></a>            <span class="at">by =</span> <span class="fu">c</span>(<span class="at">DESTIN_SZ =</span> <span class="st">"SZ"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb42-4"><a href="#cb42-4"></a>  <span class="fu">rename</span>(<span class="at">DESTIN_AGE7_12 =</span> AGE7_12,</span>
<span id="cb42-5"><a href="#cb42-5"></a>         <span class="at">DESTIN_AGE13_24 =</span> AGE13_24,</span>
<span id="cb42-6"><a href="#cb42-6"></a>         <span class="at">DESTIN_AGE25_64 =</span> AGE25_64) <span class="sc">%&gt;%</span></span>
<span id="cb42-7"><a href="#cb42-7"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(PA, SZ_NAME))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will called the output data file <em>SIM_data</em>. it is in rds data file format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="fu">write_rds</span>(flow_data1, <span class="st">"data/rds/SIM_data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="calibrating-spatial-interaction-models" class="level2">
<h2 class="anchored" data-anchor-id="calibrating-spatial-interaction-models"><strong>16.8 Calibrating Spatial Interaction Models</strong></h2>
<p>In this section, you will learn how to calibrate Spatial Interaction Models by using Poisson Regression method.</p>
<section id="importing-the-modelling-data" class="level3">
<h3 class="anchored" data-anchor-id="importing-the-modelling-data"><strong>16.8.1 Importing the modelling data</strong></h3>
<p>Firstly, let us import the modelling data by using the code chunk below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>SIM_data <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"data/rds/SIM_data.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualising-the-dependent-variable" class="level3">
<h3 class="anchored" data-anchor-id="visualising-the-dependent-variable"><strong>16.8.2 Visualising the dependent variable</strong></h3>
<p>Firstly, let us plot the distribution of the dependent variable (i.e.&nbsp;TRIPS) by using histogram method by using the code chunk below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> SIM_data,</span>
<span id="cb45-2"><a href="#cb45-2"></a>       <span class="fu">aes</span>(<span class="at">x =</span> TRIPS)) <span class="sc">+</span></span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="fu">geom_histogram</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="In-class_Ex3_2_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Notice that the distribution is highly skewed and not resemble bell shape or also known as normal distribution.</p>
<p>Next, let us visualise the relation between the dependent variable and one of the key independent variable in Spatial Interaction Model, namely distance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> SIM_data,</span>
<span id="cb46-2"><a href="#cb46-2"></a>       <span class="fu">aes</span>(<span class="at">x =</span> dist,</span>
<span id="cb46-3"><a href="#cb46-3"></a>           <span class="at">y =</span> TRIPS)) <span class="sc">+</span></span>
<span id="cb46-4"><a href="#cb46-4"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb46-5"><a href="#cb46-5"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="In-class_Ex3_2_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Notice that their relationship hardly resemble linear relationship.</p>
<p>On the other hand, if we plot the scatter plot by using the log transformed version of both variables, we can see that their relationship is more resemble linear relationship.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> SIM_data,</span>
<span id="cb47-2"><a href="#cb47-2"></a>       <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(dist),</span>
<span id="cb47-3"><a href="#cb47-3"></a>           <span class="at">y =</span> <span class="fu">log</span>(TRIPS))) <span class="sc">+</span></span>
<span id="cb47-4"><a href="#cb47-4"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="In-class_Ex3_2_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We have come to the end of our data preparation stage.</p>
</section>
<section id="checking-for-variables-with-zero-values" class="level3">
<h3 class="anchored" data-anchor-id="checking-for-variables-with-zero-values"><strong>16.8.3 Checking for variables with zero values</strong></h3>
<p>Feature engineering state starts here: We need to make our data able to work for our chosen algorithm (Poisson regression).</p>
<p>Since <strong>Poisson</strong> Regression is based of <strong>log</strong> and <strong>log 0 is undefined</strong>, it is important for us to ensure that <strong>no 0</strong> values in the explanatory variables.</p>
<p>In the code chunk below, summary() of Base R is used to compute the summary statistics of all variables in <em>SIM_data</em> data frame.</p>
</section>
<section id="unconstrained-spatial-interaction-model" class="level3">
<h3 class="anchored" data-anchor-id="unconstrained-spatial-interaction-model"><strong>16.8.4 Unconstrained Spatial Interaction Model</strong></h3>
<p>In this section, we will learn how to calibrate an unconstrained spatial interaction model by using <code>glm()</code> of Base Stats. The <strong>explanatory</strong> variables are <strong>origin population by different age cohort</strong>, <strong>destination population by different age cohort</strong> (i.e.&nbsp;<em>ORIGIN_AGE25_64</em>) and <strong>distance</strong> between origin and destination in km (i.e.&nbsp;<em>dist</em>).</p>
<p>The general formula of Unconstrained Spatial Interaction Model</p>
<p><img src="https://r4gdsa.netlify.app/chap15/img/image1.jpg" class="img-fluid"></p>
<p>The code chunk used to calibrate to model is shown below:</p>
<div class="cell">

</div>
<p>The parameter estimate for distnace is -1.517. If the sign is positive, double-check our workings.</p>
<p>AIC: GLM by default do not provide R-square, only provide AIC.</p>
<p>Compare models:</p>
<p>Doubly constrained: <strong>best</strong> model as not dispersed. 60% accuracy because we only have one/two variables if we add more variables like job opportunities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="co">#| eval: false</span></span>
<span id="cb48-2"><a href="#cb48-2"></a><span class="co">#| echo: false</span></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="co">#| fig-width: 14</span></span>
<span id="cb48-4"><a href="#cb48-4"></a><span class="co">#| fig-asp: 0.68</span></span>
<span id="cb48-5"><a href="#cb48-5"></a><span class="co">#| code-fold: True</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="summaries" class="level2">
<h2 class="anchored" data-anchor-id="summaries">Summaries</h2>
<p>OD matrix is often incomplete. Imagine trying to complete the OD matrix, it would involve us doing spatial interaction or OD surveys to find the missing values. There are 332 subzones in Singapore, and each survey is expensive,. In addition, OD matrix is constantly changing as flow patterns changes. We are trying to predict flows between origins and destinations. Flow could be thought of a function of (1) attribute of origin (propulsiveness) (2) attribute of destination (attractiveness) and (3) cost friction (like distance or transport cost or public transport stops). Assumption is that the <strong>benefits</strong> must outweigh the <strong>cost</strong> in order for flow to happen.</p>
<p><strong>Gravity model</strong> takes into consideration the interaction between all origin and destination locations.</p>
<p><strong>Potential model</strong> takes in consideration the interaction between a location and all other location pairs. (Good for measuring accessibility)</p>
<p><strong>Retail model</strong> is commonly used by franchise like KFC / Pizza Hut to determine their area/region of service (aka delivery zones) for each outlet.</p>
<p>There are 4 variations in the Gravity model:</p>
<ol type="1">
<li>Unconstrained: only the overall outflow is fixed and total outflow from origins = total inflow to destinations</li>
<li>Origin constrained: outflow by origin is fixed.</li>
<li>Destination constrained: inflow by destination is fixed.</li>
<li>Doubly constrained: outflow by origin and inflow by destination is fixed.</li>
</ol>
<p>To calculate flow from each origin to each destination, we need parameters like k, alpha, lambda and beta. The beta for distance is usually negative because we assume that there is an inverse relationship between interaction and distance, like Newtonian physics and laws of gravity.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
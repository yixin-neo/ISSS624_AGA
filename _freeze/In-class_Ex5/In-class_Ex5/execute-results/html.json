{
  "hash": "8361c658668f6367331ae0af7d7751fa",
  "result": {
    "markdown": "---\ntitle: \"In-class Exercise 5: Spatial Econometric Interaction Models\"\nauthor: \"NeoYX\"\ndate: '16 Dec 2023'\ndate-modified: \"2023-12-16\"\neditor: visual\nexecute: \n  freeze: auto\n  warning: false\n  #echo: false\n  #message: false\nformat: \n  html:\n    code-fold: false\n    code-overflow: scroll\n    code-summary: \"Show the code\"\n    code-line-numbers: true\n---\n\n\nThe main new package used today will be [`spflow`](https://lukece.github.io/spflow/). It is recently developed as a software tool in 2021.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#devtools::install_github('LukeCe/spflow')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, tmap, spdep, sp, Matrix, spflow, reshape2, knitr, tidyverse)\n```\n:::\n\n\n## Data Preparation\n\nWe need three datasets, namely:\n\n-   a spatial weights,\n\n-   a tibble data frame consists of the origins, dest, flows and distances between the origins and destination, and\n\n-   a tibble dataframe that consists of the explanatory variables.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n**Key differences in data preparation:**\n\n-   In spatial economics model, we do not need to remove the intra-zonal trips because the model can account for it.\n\n-   Do not need to explicitly label an attribute as an origin or destination variable when using the `spflow` package.\n\n### Load our rds data into R:\n\n`mpsz_flow`: i-j pairs, distance and trips (used to create `spflow_network_pair)`\n\n`mpsz_nb`: neighbours weights (used to create `spflow_network-class)`\n\n`mpsz_var`: attributes (used to create `spflow_network-class)`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_nb<- read_rds('data/rds/mpsz_nb.rds')\nmpsz_flow<- read_rds('data/rds/mpsz_flow.rds')\nmpsz_var<- read_rds('data/rds/mpsz_var.rds')\n```\n:::\n\n\n### Creating `spflow_network-class` objects. \n\nIt is a S4 class that contains all information on a spatial network which is composed by a set of nodes that are linked by some neighbourhood relation. We need **neighbour list** and **attributes**.\n\n\\*Note that we should not use 'fixed distance' nb method here as there was a subzone without a neighbour during data preparation just now.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_net <- spflow_network(\n  id_net = 'sg',  # give it an id\n  node_neighborhood = \n    nb2mat(mpsz_nb$by_contiguity),\n  node_data = mpsz_var,\n  node_key_column = 'SZ_CODE')\n```\n:::\n\n\nNew to this package, explore the structure of our new object class.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstr(mpsz_net)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nFormal class 'spflow_network' [package \"spflow\"] with 3 slots\n  ..@ id_net           : chr \"sg\"\n  ..@ node_neighborhood:Formal class 'dgCMatrix' [package \"Matrix\"] with 6 slots\n  .. .. ..@ i       : int [1:1902] 1 2 65 68 0 2 31 36 37 68 ...\n  .. .. ..@ p       : int [1:314] 0 4 11 18 22 24 32 37 41 48 ...\n  .. .. ..@ Dim     : int [1:2] 313 313\n  .. .. ..@ Dimnames:List of 2\n  .. .. .. ..$ : chr [1:313] \"1\" \"2\" \"3\" \"4\" ...\n  .. .. .. ..$ : NULL\n  .. .. ..@ x       : num [1:1902] 0.143 0.143 0.2 0.125 0.25 ...\n  .. .. ..@ factors : list()\n  .. .. ..$ spectral_character: Named cplx [1:3] 1+0i 1+0i -0.535+0i\n  .. .. .. ..- attr(*, \"names\")= chr [1:3] \"LM\" \"LR\" \"SR\"\n  ..@ node_data        :'data.frame':\t313 obs. of  15 variables:\n  .. ..$ SZ_NAME       : chr [1:313] \"INSTITUTION HILL\" \"ROBERTSON QUAY\" \"FORT CANNING\" \"MARINA EAST (MP)\" ...\n  .. ..$ SZ_CODE       : Factor w/ 313 levels \"RVSZ05\",\"SRSZ01\",..: 1 2 3 4 5 6 7 8 9 10 ...\n  .. ..$ BUSSTOP_COUNT : int [1:313] 2 10 6 2 1 10 5 4 21 11 ...\n  .. ..$ AGE7_12       : num [1:313] 330 320 0 0 200 0 0 0 350 470 ...\n  .. ..$ AGE13_24      : num [1:313] 360 350 10 0 260 0 0 0 460 1160 ...\n  .. ..$ AGE25_64      : num [1:313] 2260 2200 30 0 1440 0 0 0 2600 6260 ...\n  .. ..$ SCHOOL_COUNT  : int [1:313] 1 0 0 0 0 0 0 0 0 2 ...\n  .. ..$ BUSINESS_COUNT: int [1:313] 6 4 7 0 1 11 15 1 10 1 ...\n  .. ..$ RETAILS_COUNT : int [1:313] 26 207 17 0 84 14 52 0 460 34 ...\n  .. ..$ FINSERV_COUNT : int [1:313] 3 18 0 0 29 4 6 0 34 4 ...\n  .. ..$ ENTERTN_COUNT : int [1:313] 0 6 3 0 2 0 0 0 1 0 ...\n  .. ..$ FB_COUNT      : int [1:313] 4 38 4 0 38 15 5 0 20 0 ...\n  .. ..$ LR_COUNT      : int [1:313] 3 11 7 0 20 0 0 0 19 2 ...\n  .. ..$ COORD_X       : num [1:313] 104 104 104 104 104 ...\n  .. ..$ COORD_Y       : num [1:313] 1.29 1.29 1.29 1.29 1.25 ...\n  .. ..- attr(*, \"coord_columns\")= chr [1:2] \"COORD_X\" \"COORD_Y\"\n  .. ..- attr(*, \"node_key_column\")= chr \"SZ_CODE\"\n```\n:::\n\n```{.r .cell-code}\n#mpsz_net@node_neighborhood\n```\n:::\n\n\n### Create `spflow_network_pair()` data\n\nIt will contain origin and destination subzones, distance and trips (flow).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_net_pairs <- spflow_network_pair(\n  id_orig_net = 'sg',\n  id_dest_net = 'sg',\n  pair_data = mpsz_flow,\n  orig_key_column = 'ORIGIN_SZ',\n  dest_key_column = 'DESTIN_SZ')\n```\n:::\n\n\n### Combine first two objects together to get `spflow_network_multi()`.\n\nCareful: Do not reverse the order of mpsz_net and mpsz_net_pairs. Follow the syntax carefully.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz_multi_net <- spflow_network_multi(mpsz_net, \n                                       mpsz_net_pairs)\n```\n:::\n\n\n## Correlation Anaylsis\n\nCheck for Multi-collinearity to avoid including explanatory var that are highly correlated, using `spflow` package:\n\n-   [`pair_cor`](https://lukece.github.io/spflow/reference/pair_cor.html)`()` to create a correlation matrix, and\n\n-   [`cor_image`](https://lukece.github.io/spflow/reference/cor_image.html)`()` to plot the correlation matrix as a correlogram.\n\n\n::: {.cell fig.asp='0.68'}\n\n```{.r .cell-code}\n# run all to test\ncor_formula <- log(1+ TRIPS) ~ # 1 is to avoid log 0\n  BUSSTOP_COUNT +\n  AGE7_12+ \n  AGE13_24 +\n  AGE25_64 +\n  SCHOOL_COUNT +\n  BUSINESS_COUNT +\n  RETAILS_COUNT +\n  FINSERV_COUNT +\n  P_(log(DISTANCE + 1))  # impedence/ resistance/ cost\n\n\ncor_mat <- pair_cor(\n  mpsz_multi_net,\n  #id_net_pair = id(object)[[\"pairs\"]][[1]],\n  spflow_formula = cor_formula,\n  add_lags_x = FALSE,\n  #add_lags_y = FALSE\n)\n\ncolnames(cor_mat) <- paste0(\n  substr(\n    colnames(cor_mat),1,3), '...')\n\ncor_image(cor_mat)\n```\n\n::: {.cell-output-display}\n![](In-class_Ex5_files/figure-html/unnamed-chunk-12-1.png){width=1344}\n:::\n:::\n\n\nObserved that most of the age groups are highly correlated, two choices:\n\n-   aggregate all the age groups\n\n-   exclude some age group\n\n## Model Calibration\n\nThree [`spflow`](https://lukece.github.io/spflow/reference/spflow.html)`()` models available, check documentation.\n\n-   maximum likelihood (MLE) \\<- this is the default.\n\n-   Tailspin two stafe least sqaure (S2SLS)\n\n-   Bayes Markov chain monte carlo (MCMC)\n\n`O_(X1) + D_(X2) + I_(X3) + P_(X4)`\n\nI refers to intra-zonal -flow, P is impedence\n\nThis model goes beyong spatial interaction model by telling us whether one's neighbours' variable values are statistically significant and their coefficients.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase_model <- spflow(\n  spflow_formula = log(1 + TRIPS) ~\n    O_(BUSSTOP_COUNT+\n         AGE25_64) +\n    D_(SCHOOL_COUNT +\n         BUSINESS_COUNT +\n         RETAILS_COUNT +\n         FINSERV_COUNT) +\n    P_(log(DISTANCE + 1)),\n  spflow_networks = mpsz_multi_net)\n\nbase_model\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n--------------------------------------------------\nSpatial interaction model estimated by: MLE  \nSpatial correlation structure: SDM (model_9)\nDependent variable: log(1 + TRIPS)\n\n--------------------------------------------------\nCoefficients:\n                          est     sd   t.stat  p.val\nrho_d                   0.680  0.004  192.554  0.000\nrho_o                   0.678  0.004  187.733  0.000\nrho_w                  -0.396  0.006  -65.592  0.000\n(Intercept)             0.410  0.065    6.267  0.000\n(Intra)                 1.312  0.081   16.262  0.000\nD_SCHOOL_COUNT          0.017  0.002    7.885  0.000\nD_SCHOOL_COUNT.lag1     0.002  0.004    0.552  0.581\nD_BUSINESS_COUNT        0.000  0.000    3.015  0.003\nD_BUSINESS_COUNT.lag1   0.000  0.000   -0.249  0.804\nD_RETAILS_COUNT         0.000  0.000   -0.306  0.759\nD_RETAILS_COUNT.lag1    0.000  0.000    0.152  0.880\nD_FINSERV_COUNT         0.002  0.000    6.787  0.000\nD_FINSERV_COUNT.lag1   -0.002  0.001   -3.767  0.000\nO_BUSSTOP_COUNT         0.002  0.000    6.807  0.000\nO_BUSSTOP_COUNT.lag1   -0.001  0.000   -2.364  0.018\nO_AGE25_64              0.000  0.000    7.336  0.000\nO_AGE25_64.lag1         0.000  0.000   -2.797  0.005\nP_log(DISTANCE + 1)    -0.050  0.007   -6.794  0.000\n\n--------------------------------------------------\nR2_corr: 0.6942948  \nObservations: 97969  \nModel coherence: Validated\n```\n:::\n:::\n\n\n'*rho_d*': destination constrain\n\n'*rho_w*': intra_zonal constrain\n\n'*D_SCHOOL_COUNT*' : the coefficient of school count at that subzone (statisically significant)\n\n'*D_SCHOOL_COUNT.lag1*' : coefficient of neighbouring schools (NOT significant)\n\nRetail count is not a good explanatory variable as well.\nFinancial service count is a good explanatory variable.\n\n### \nMoran scatterplot (wrapper of spdep) of residuals\n\n**If points are closer to zero line, less chance of autocorrelation.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nold_par <- par(mfrow = c(1,3),\n               mar = c(2,2,2,2))\nspflow_moran_plots(base_model)\n```\n\n::: {.cell-output-display}\n![](In-class_Ex5_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n\n```{.r .cell-code}\npar(old_par)\n```\n:::\n\n\nNext, `pair_cor()` can be used to inspect the relationship of the **residual** and the **explanatory variables** by using the code chunk below.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncorr_residual <- pair_cor(base_model) # this time round input the fitted model into pair_cor() to see residuals in cor plot\ncolnames(corr_residual) <- substr(colnames(corr_residual),1,3)\ncor_image(corr_residual)\n```\n\n::: {.cell-output-display}\n![](In-class_Ex5_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n## \nWorking with model control\n\n\n::: {.cell}\n\n```{.r .cell-code}\nspflow_formula<- log(1 + TRIPS) ~\n    O_(BUSSTOP_COUNT+\n         AGE25_64) +\n    D_(SCHOOL_COUNT +\n         BUSINESS_COUNT +\n         RETAILS_COUNT +\n         FINSERV_COUNT) +\n    P_(log(DISTANCE + 1))\n\nmodel_control <- spflow_control(\n  estimation_method = \"mle\",\n  model = 'model_1') # there are many models to choose from, check lecture notes.\n#model_8 will take special care of intra-zonal trips! our model has larger intra-zonal trips\n\nmle_model1 <- spflow(\n  spflow_formula,\n  spflow_networks = mpsz_multi_net,\n  estimation_control = model_control)\n\nmle_model1\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n--------------------------------------------------\nSpatial interaction model estimated by: OLS  \nSpatial correlation structure: SLX (model_1)\nDependent variable: log(1 + TRIPS)\n\n--------------------------------------------------\nCoefficients:\n                          est     sd    t.stat  p.val\n(Intercept)            11.384  0.069   164.255  0.000\n(Intra)                -6.006  0.112   -53.393  0.000\nD_SCHOOL_COUNT          0.093  0.003    28.599  0.000\nD_SCHOOL_COUNT.lag1     0.255  0.006    44.905  0.000\nD_BUSINESS_COUNT        0.001  0.000    10.036  0.000\nD_BUSINESS_COUNT.lag1   0.003  0.000    18.274  0.000\nD_RETAILS_COUNT         0.000  0.000    -1.940  0.052\nD_RETAILS_COUNT.lag1    0.000  0.000    -2.581  0.010\nD_FINSERV_COUNT         0.005  0.000    10.979  0.000\nD_FINSERV_COUNT.lag1   -0.016  0.001   -17.134  0.000\nO_BUSSTOP_COUNT         0.014  0.001    25.865  0.000\nO_BUSSTOP_COUNT.lag1    0.015  0.001    21.728  0.000\nO_AGE25_64              0.000  0.000    14.479  0.000\nO_AGE25_64.lag1         0.000  0.000    14.452  0.000\nP_log(DISTANCE + 1)    -1.281  0.008  -165.327  0.000\n\n--------------------------------------------------\nR2_corr: 0.2831458  \nObservations: 97969  \nModel coherence: Validated\n```\n:::\n:::\n\n::: {.cell}\n\n:::\n",
    "supporting": [
      "In-class_Ex5_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}